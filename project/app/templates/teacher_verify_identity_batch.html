
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Batch Student Identity Verification</title>
  <style>
    body {font-family:sans-serif;margin:40px;}
    .summary {margin-bottom:20px;padding:15px;background:#f0f7ff;border-radius:5px;}
    table {border-collapse:collapse;width:100%;margin-top:20px;}
    th, td {border:1px solid #ddd;padding:8px;text-align:left;}
    th {background-color:#f2f2f2;}
    tr:nth-child(even) {background-color:#f9f9f9;}
    .success {color:green;}
    .fail {color:red;}
    .missing {color:orange;}
    .form-section {background:#f9f9f9;padding:20px;border-radius:6px;max-width:500px;}
    select,input[type=file] {width:100%;padding:8px;margin-bottom:12px;}
    button {padding:8px 18px;border:none;border-radius:5px;background:#007bff;color:white;cursor:pointer;}
    button:hover {background:#0056b3;}
    .back-btn {background:#6c757d;}
    .back-btn:hover {background:#495057;}
  </style>
</head>
<body>
  <h1>Batch Student Identity Verification</h1>

  {% with msgs = get_flashed_messages() %}
    {% if msgs %}
      <ul style="color:red">
        {% for m in msgs %}
          <li>{{ m }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <div class="form-section">
    <form method="post" enctype="multipart/form-data">
      <label>API:
        <select name="api_choice">
          <option value="auto" {% if api_choice == 'auto' %}selected{% endif %}>Auto (try all)</option>
          {% for c in configs %}
            <option value="{{ c.id }}" {% if c.id|string == api_choice %}selected{% endif %}>{{ c.service_type }} ({{ c.path }})</option>
          {% endfor %}
        </select>
      </label>
      <label>Upload Excel File:
        <input type="file" name="file" accept=".xlsx" required>
      </label>
      <button type="submit">Batch Verify</button>
    </form>
    <p style="font-size:13px;color:#666;">Excel需包含列：name, id</p>
  </div>

  {% if results %}
    <div class="summary">
      <h3>Summary</h3>
      <p>Total records: {{ results|length }}</p>
      {% set success_count = results|selectattr('status', 'equalto', 'y')|list|length %}
      {% set fail_count = results|selectattr('status', 'equalto', 'fail')|list|length %}
      {% set missing_count = results|selectattr('status', 'equalto', 'missing')|list|length %}
      <p>Success: <span class="success">{{ success_count }}</span> |
         Failed: <span class="fail">{{ fail_count }}</span> |
         Incomplete: <span class="missing">{{ missing_count }}</span></p>
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Student ID</th>
          <th>Status</th>
          <th>Major</th>
          <th>Info</th>
          <th>Error</th>
        </tr>
      </thead>
      <tbody>
        {% for r in results %}
        <tr>
          <td>{{ r.name }}</td>
          <td>{{ r.id }}</td>
          <td class="{{ r.status }}">
            {% if r.status == 'y' %}Success
            {% elif r.status == 'fail' %}Failed
              {% if r.error_message %}<br><small>({{ r.error_message }})</small>{% endif %}
            {% elif r.status == 'missing' %}Incomplete
            {% else %}{{ r.status }}{% endif %}
          </td>
          <td>{{ r.major if r.major else '-' }}</td>
          <td>{{ r.info if r.info else '-' }}</td>
          <td>{% if r.error_message %}{{ r.error_message }}{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <div style="margin-top:30px;">
    <a href="{{ url_for('teacher.dashboard') }}"><button class="back-btn">Back to Dashboard</button></a>
    <a href="{{ url_for('teacher.verify_identity') }}"><button class="back-btn">Single Identity Verification</button></a>
  </div>
</body>
</html>
